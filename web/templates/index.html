<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-left">
                    <h1>{{.title}}</h1>
                    <p>管理您的 Augment Token</p>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <span class="user-welcome">欢迎，<strong id="currentUser">管理员</strong></span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="logout()" title="登出">
                            <span class="btn-icon bi bi-box-arrow-right"></span>
                            <span class="btn-text">登出</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <section class="token-list">
                <div class="section-header">
                    <h2>Token 列表</h2>
                    <div class="header-actions">
                        <button class="btn btn-info" onclick="batchRefreshTokens()" id="batchRefreshBtn" title="批量刷新所有Token">
                            <span class="btn-icon bi bi-arrow-clockwise"></span>
                            <span>全部刷新</span>
                        </button>
                        <button class="btn btn-primary" onclick="openGetTokenModal()" title="获取新的Token">
                            <span class="btn-icon bi bi-download"></span>
                            <span>获取 Token</span>
                        </button>
                        <button class="btn btn-success" onclick="openAddModal()" title="添加新的Token">
                            <span class="btn-icon bi bi-plus-lg"></span>
                            <span>添加 Token</span>
                        </button>
                    </div>
                </div>

                <!-- Token 表格容器 -->
                <div class="token-table-container">
                    <table class="token-table">
                        <thead>
                            <tr>
                                <th>邮箱备注</th>
                                <th>创建时间</th>
                                <th>过期时间</th>
                                <th>剩余次数</th>
                                <th>账号状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="tokenTableBody">
                            <!-- Token 数据将通过 JavaScript 动态加载 -->
                        </tbody>
                    </table>
                </div>

                <!-- 加载状态 -->
                <div class="loading-state" id="loadingState" style="text-align: center; padding: 40px;">
                    <div class="spinner">
                        <i class="bi bi-arrow-clockwise spinning" style="font-size: 24px; color: #007bff;"></i>
                    </div>
                    <p style="margin-top: 10px; color: #666;">正在加载 Token 数据...</p>
                </div>

                <!-- 空状态 -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <p>暂无 Token 数据</p>
                    <p>请添加您的第一个 Augment Token</p>
                    <button class="btn btn-success" onclick="openAddModal()">添加第一个 Token</button>
                </div>

                <!-- 分页器 -->
                <div class="pagination-container" id="paginationContainer" style="display: none;">
                    <div class="pagination-info">
                        <span id="paginationInfo">显示第 1-10 条，共 0 条记录</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="btn btn-sm btn-secondary" id="firstPageBtn" onclick="goToPage(1)" disabled>
                            <span class="btn-icon bi bi-chevron-double-left"></span>
                            <span class="btn-text">首页</span>
                        </button>
                        <button class="btn btn-sm btn-secondary" id="prevPageBtn" onclick="goToPrevPage()" disabled>
                            <span class="btn-icon bi bi-chevron-left"></span>
                            <span class="btn-text">上一页</span>
                        </button>
                        <div class="pagination-pages" id="paginationPages">
                            <!-- 页码按钮将通过JavaScript动态生成 -->
                        </div>
                        <button class="btn btn-sm btn-secondary" id="nextPageBtn" onclick="goToNextPage()" disabled>
                            <span class="btn-text">下一页</span>
                            <span class="btn-icon bi bi-chevron-right"></span>
                        </button>
                        <button class="btn btn-sm btn-secondary" id="lastPageBtn" onclick="goToLastPage()" disabled>
                            <span class="btn-text">末页</span>
                            <span class="btn-icon bi bi-chevron-double-right"></span>
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <!-- 添加 Token 模态框 -->
        <div id="addModal" class="modal">
            <div class="modal-content add-token-modal-content">
                <div class="modal-header">
                    <h3>添加 Token</h3>
                    <span class="close" onclick="closeAddModal()">&times;</span>
                </div>

                <!-- 标签页导航 -->
                <div class="tab-navigation">
                    <div class="tab-nav-item active" onclick="switchAddTab('single')" id="singleAddTab">
                        <span class="tab-icon bi bi-plus-circle"></span>
                        <span class="tab-text">单个添加</span>
                    </div>
                    <div class="tab-nav-item" onclick="switchAddTab('batch')" id="batchAddTab">
                        <span class="tab-icon bi bi-file-earmark-spreadsheet"></span>
                        <span class="tab-text">批量导入</span>
                    </div>
                </div>

                <!-- 单个添加标签页 -->
                <div id="singleAddContent" class="tab-content active">
                    <form id="addTokenForm" class="modal-form">
                        <div class="form-group">
                            <label for="add_tenant_url">Tenant URL:</label>
                            <input type="url" id="add_tenant_url" name="tenant_url" placeholder="https://example.api.augmentcode.com/" required>
                        </div>
                        <div class="form-group">
                            <label for="add_access_token">Access Token:</label>
                            <textarea id="add_access_token" name="access_token" placeholder="输入 Access Token" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="add_portal_url">Portal URL (可选):</label>
                            <input type="url" id="add_portal_url" name="portal_url" placeholder="https://portal.withorb.com/view?token=...">
                        </div>
                        <div class="form-group">
                            <label for="add_email_note">邮箱备注 (可选):</label>
                            <input type="text" id="add_email_note" name="email_note" placeholder="邮箱备注信息">
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeAddModal()" title="取消添加">
                                <span class="btn-icon bi bi-x-lg"></span>
                                <span>取消</span>
                            </button>
                            <button type="submit" class="btn btn-success" title="添加Token">
                                <span class="btn-icon bi bi-plus-lg"></span>
                                <span>添加</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 批量导入标签页 -->
                <div id="batchAddContent" class="tab-content">
                    <div class="modal-form">
                        <!-- 文件上传区域 -->
                        <div class="form-group">
                            <label>CSV 文件上传:</label>
                            <div class="file-upload-area" id="fileUploadArea">
                                <div class="upload-placeholder">
                                    <i class="bi bi-cloud-upload" style="font-size: 48px; color: #007bff;"></i>
                                    <p>拖拽 CSV 文件到此处，或 <a href="#" onclick="triggerFileSelect()">点击选择文件</a></p>
                                    <p class="upload-hint">支持的格式：CSV 文件，最大 5MB</p>
                                </div>
                                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                            </div>
                        </div>

                        <!-- 模板下载 -->
                        <div class="form-group">
                            <label>CSV 模板:</label>
                            <div class="template-download">
                                <button type="button" class="btn btn-sm btn-info" onclick="downloadCSVTemplate()">
                                    <span class="btn-icon bi bi-download"></span>
                                    <span>下载 CSV 模板</span>
                                </button>
                                <span class="template-hint">下载标准格式模板，包含示例数据</span>
                            </div>
                        </div>



                        <!-- 导入进度 -->
                        <div class="form-group" id="importProgressSection" style="display: none;">
                            <label>导入进度:</label>
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <div class="progress-text" id="progressText">准备导入...</div>
                            </div>
                        </div>



                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeAddModal()" title="取消导入">
                                <span class="btn-icon bi bi-x-lg"></span>
                                <span>取消</span>
                            </button>
                            <button type="button" class="btn btn-success" id="batchImportBtn" onclick="startBatchImport()" disabled title="开始批量导入">
                                <span class="btn-icon bi bi-upload"></span>
                                <span>开始导入</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑 Token 模态框 -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>编辑 Token</h3>
                    <span class="close" onclick="closeEditModal()">&times;</span>
                </div>
                <form id="editTokenForm" class="modal-form">
                    <input type="hidden" id="edit_token_id" name="token_id">
                    <div class="form-group">
                        <label for="edit_tenant_url">Tenant URL:</label>
                        <input type="url" id="edit_tenant_url" name="tenant_url" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_access_token">Access Token:</label>
                        <textarea id="edit_access_token" name="access_token" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit_portal_url">Portal URL (可选):</label>
                        <input type="url" id="edit_portal_url" name="portal_url">
                    </div>
                    <div class="form-group">
                        <label for="edit_email_note">邮箱备注 (可选):</label>
                        <input type="text" id="edit_email_note" name="email_note">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()" title="取消编辑">
                            <span class="btn-icon bi bi-x-lg"></span>
                            <span>取消</span>
                        </button>
                        <button type="submit" class="btn btn-primary" title="保存更改">
                            <span class="btn-icon bi bi-check-lg"></span>
                            <span>保存更改</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 使用 Token 选项模态框 -->
        <div id="useModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>选择编辑器</h3>
                    <span class="close" onclick="closeUseModal()">&times;</span>
                </div>
                <div class="modal-form">
                    <div class="use-options">
                        <!-- 第一行：VSCode 和 Cursor -->
                        <div class="use-option-card" data-editor="vscode" onclick="useInEditor('vscode')" title="使用 VSCode 打开">
                            <div class="use-option-icon">
                                <img src="/static/icon/vscode.svg" alt="VSCode" width="48" height="48">
                            </div>
                            <div class="use-option-content">
                                <h4>VSCode</h4>
                            </div>
                        </div>

                        <div class="use-option-card" data-editor="cursor" onclick="useInEditor('cursor')" title="使用 Cursor 打开">
                            <div class="use-option-icon">
                                <img src="/static/icon/cursor.svg" alt="Cursor" width="48" height="48">
                            </div>
                            <div class="use-option-content">
                                <h4>Cursor</h4>
                            </div>
                        </div>

                        <!-- 第二行：Kiro 和 Trae -->
                        <div class="use-option-card" data-editor="kiro" onclick="useInEditor('kiro')" title="使用 Kiro 打开">
                            <div class="use-option-icon">
                                <img src="/static/icon/kiro.svg" alt="Kiro" width="48" height="48">
                            </div>
                            <div class="use-option-content">
                                <h4>Kiro</h4>
                            </div>
                        </div>

                        <div class="use-option-card" data-editor="trae" onclick="useInEditor('trae')" title="使用 Trae 打开">
                            <div class="use-option-icon">
                                <img src="/static/icon/trae.svg" alt="Trae" width="48" height="48">
                            </div>
                            <div class="use-option-content">
                                <h4>Trae</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 获取 Token 模态框 -->
        <div id="getTokenModal" class="modal">
            <div class="modal-content get-token-modal-content">
                <div class="modal-header">
                    <h3>获取 Token</h3>
                    <span class="close" onclick="closeGetTokenModal()">&times;</span>
                </div>

                <!-- 步骤指示器 -->
                <div class="step-indicator">
                    <div class="step active" id="step1-indicator">
                        <span class="step-number">1</span>
                        <span class="step-title">生成授权URL</span>
                    </div>
                    <div class="step-divider"></div>
                    <div class="step" id="step2-indicator">
                        <span class="step-number">2</span>
                        <span class="step-title">输入授权码</span>
                    </div>
                </div>

                <!-- 第一步：授权URL生成 -->
                <div id="getTokenStep1" class="get-token-step active">
                    <div class="step-content">
                        <h4>第一步：生成授权URL</h4>
                        <p>点击下方按钮生成授权URL，然后在浏览器中打开进行授权。</p>

                        <div class="form-group">
                            <label>授权URL：</label>
                            <div class="url-input-group">
                                <input type="text" id="authUrl" readonly placeholder="点击生成按钮获取授权URL">
                                <button type="button" class="btn btn-sm btn-secondary" onclick="copyAuthUrl()" title="复制URL" id="copyUrlBtn" disabled>
                                    <span class="btn-icon bi bi-clipboard"></span>
                                </button>
                                <button type="button" class="btn btn-sm btn-info" onclick="openAuthUrl()" title="打开授权页面" id="openUrlBtn" disabled>
                                    <span class="btn-icon bi bi-box-arrow-up-right"></span>
                                </button>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-primary" onclick="generateAuthUrl()" id="generateUrlBtn">
                                <span class="btn-icon bi bi-download"></span>
                                <span>生成授权URL</span>
                            </button>
                            <button type="button" class="btn btn-success" onclick="goToStep2()" id="nextStepBtn" disabled>
                                <span class="btn-icon bi bi-arrow-right"></span>
                                <span>下一步</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 第二步：授权码输入 -->
                <div id="getTokenStep2" class="get-token-step">
                    <div class="step-content">
                        <h4>第二步：输入授权响应</h4>
                        <p>完成授权后，将浏览器返回的JSON响应内容粘贴到下方文本框中。</p>

                        <div class="form-group">
                            <label for="authResponse">授权响应JSON：</label>
                            <textarea id="authResponse" rows="8" placeholder='请粘贴授权响应的JSON内容，例如：
{
    "code": "your_code",
    "state": "random_string",
    "tenant_url": "https://example.api.augmentcode.com/"
}'></textarea>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="goToStep1()">
                                <span class="btn-icon bi bi-arrow-left"></span>
                                <span>上一步</span>
                            </button>
                            <button type="button" class="btn btn-success" onclick="saveTokenFromAuth()">
                                <span class="btn-icon bi bi-check-lg"></span>
                                <span>保存 Token</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 删除确认对话框 -->
        <div id="deleteConfirmModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h3>确认删除</h3>
                    <span class="close" onclick="closeDeleteConfirmModal()">&times;</span>
                </div>
                <div class="modal-form">
                    <div class="delete-confirm-content">
                        <div class="warning-icon">
                            <i class="bi bi-exclamation-triangle" style="font-size: 48px; color: #dc3545;"></i>
                        </div>
                        <p class="delete-message">您确定要删除这个 Token 吗？</p>
                        <div class="token-info">
                            <strong>Token 信息：</strong>
                            <div id="deleteTokenInfo" class="token-details"></div>
                        </div>
                        <p class="warning-text">此操作无法撤销！</p>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmModal()" title="取消删除">
                            <span class="btn-icon bi bi-x-lg"></span>
                            <span>取消</span>
                        </button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteToken()" title="确认删除">
                            <span class="btn-icon bi bi-trash"></span>
                            <span>确认删除</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>© 2025 KleinerSource. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // 模态框控制函数
        function openAddModal() {
            document.getElementById('addModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('addTokenForm').reset();

            // 重置批量导入状态
            resetBatchImportState();
        }

        function openEditModal() {
            document.getElementById('editModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('editTokenForm').reset();
        }

        function openUseModal(tokenId) {
            // 存储当前选中的 Token ID
            window.currentUseTokenId = tokenId;
            document.getElementById('useModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeUseModal() {
            document.getElementById('useModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            window.currentUseTokenId = null;
        }

        function openGetTokenModal() {
            document.getElementById('getTokenModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            // 重置到第一步
            resetGetTokenModal();
        }

        function closeGetTokenModal() {
            document.getElementById('getTokenModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            // 重置模态框状态
            resetGetTokenModal();
        }

        function resetGetTokenModal() {
            // 重置步骤指示器
            document.getElementById('step1-indicator').classList.add('active');
            document.getElementById('step2-indicator').classList.remove('active');

            // 显示第一步，隐藏第二步
            document.getElementById('getTokenStep1').classList.add('active');
            document.getElementById('getTokenStep2').classList.remove('active');

            // 重置表单
            document.getElementById('authUrl').value = '';
            document.getElementById('authResponse').value = '';

            // 重置按钮状态
            document.getElementById('copyUrlBtn').disabled = true;
            document.getElementById('openUrlBtn').disabled = true;
            document.getElementById('nextStepBtn').disabled = true;

            // 重置生成按钮
            const generateBtn = document.getElementById('generateUrlBtn');
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<span class="btn-icon bi bi-download"></span><span>生成授权URL</span>';

            // 清除存储的OAuth状态
            window.currentOAuthState = null;
        }

        function goToStep2() {
            // 更新步骤指示器
            document.getElementById('step1-indicator').classList.remove('active');
            document.getElementById('step2-indicator').classList.add('active');

            // 切换步骤内容
            document.getElementById('getTokenStep1').classList.remove('active');
            document.getElementById('getTokenStep2').classList.add('active');
        }

        function goToStep1() {
            // 更新步骤指示器
            document.getElementById('step1-indicator').classList.add('active');
            document.getElementById('step2-indicator').classList.remove('active');

            // 切换步骤内容
            document.getElementById('getTokenStep1').classList.add('active');
            document.getElementById('getTokenStep2').classList.remove('active');
        }

        function generateAuthUrl() {
            const generateBtn = document.getElementById('generateUrlBtn');
            const originalContent = generateBtn.innerHTML;

            // 显示加载状态
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="btn-icon bi bi-arrow-clockwise spinning"></span><span>生成中...</span>';

            // 调用API生成授权URL
            fetch('/api/auth/generate-url')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 存储OAuth状态
                        window.currentOAuthState = data.data;

                        // 显示授权URL
                        document.getElementById('authUrl').value = data.data.auth_url;

                        // 启用相关按钮
                        document.getElementById('copyUrlBtn').disabled = false;
                        document.getElementById('openUrlBtn').disabled = false;
                        document.getElementById('nextStepBtn').disabled = false;

                        showNotification(data.message || '授权URL生成成功', 'success');
                    } else {
                        showNotification(data.error || '生成授权URL失败', 'error');
                    }
                })
                .catch(error => {
                    console.error('生成授权URL错误:', error);
                    showNotification('生成授权URL失败: ' + error.message, 'error');
                })
                .finally(() => {
                    // 恢复按钮状态
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = originalContent;
                });
        }

        function copyAuthUrl() {
            const authUrl = document.getElementById('authUrl').value;
            if (!authUrl) {
                showNotification('没有可复制的URL', 'error');
                return;
            }

            // 显示复制按钮的加载状态
            const copyBtn = document.getElementById('copyUrlBtn');
            const originalContent = copyBtn.innerHTML;
            copyBtn.disabled = true;
            copyBtn.innerHTML = '<span class="btn-icon bi bi-arrow-clockwise spinning"></span>';

            copyToClipboard(authUrl).then(function() {
                showNotification('授权URL已复制到剪贴板', 'success');
            }).catch(function(error) {
                console.error('复制授权URL失败:', error);
                showNotification('复制授权URL失败: ' + error.message, 'error');
            }).finally(function() {
                // 恢复按钮状态
                setTimeout(() => {
                    copyBtn.disabled = false;
                    copyBtn.innerHTML = originalContent;
                }, 500); // 短暂延迟以显示操作完成
            });
        }

        function openAuthUrl() {
            const authUrl = document.getElementById('authUrl').value;
            if (!authUrl) {
                showNotification('没有可打开的URL', 'error');
                return;
            }

            // 在新标签页中打开授权URL
            window.open(authUrl, '_blank');
            showNotification('已在新标签页中打开授权页面', 'info');
        }

        function saveTokenFromAuth() {
            const authResponseText = document.getElementById('authResponse').value.trim();

            // 验证输入不为空
            if (!authResponseText) {
                showNotification('请输入授权响应JSON内容', 'error');
                return;
            }

            // 验证是否有OAuth状态
            if (!window.currentOAuthState) {
                showNotification('OAuth状态丢失，请重新开始授权流程', 'error');
                return;
            }

            let authResponse;
            try {
                // 解析JSON
                authResponse = JSON.parse(authResponseText);
            } catch (error) {
                showNotification('授权响应JSON格式错误: ' + error.message, 'error');
                return;
            }

            // 验证必需字段
            if (!authResponse.code) {
                showNotification('授权响应中缺少code字段', 'error');
                return;
            }

            if (!authResponse.state) {
                showNotification('授权响应中缺少state字段', 'error');
                return;
            }

            if (!authResponse.tenant_url) {
                showNotification('授权响应中缺少tenant_url字段', 'error');
                return;
            }

            // 验证state匹配
            if (authResponse.state !== window.currentOAuthState.state) {
                showNotification('state参数不匹配，可能存在安全风险', 'error');
                return;
            }

            // 显示加载状态
            const saveBtn = document.querySelector('#getTokenStep2 .btn-success');
            const originalContent = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="btn-icon bi bi-arrow-clockwise spinning"></span><span>保存中...</span>';

            // 准备请求数据
            const requestData = {
                auth_response: authResponse,
                oauth_state: window.currentOAuthState
            };

            // 发送token交换请求
            fetch('/api/auth/exchange-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message || 'Token获取并保存成功', 'success');
                    closeGetTokenModal();
                    // 动态刷新Token列表，回到第一页显示新获取的Token
                    setTimeout(() => {
                        refreshTokenListToFirstPage();
                    }, 500);
                } else {
                    showNotification(data.error || '保存Token失败', 'error');
                }
            })
            .catch(error => {
                console.error('保存Token错误:', error);
                showNotification('保存Token失败: ' + error.message, 'error');
            })
            .finally(() => {
                // 恢复按钮状态
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalContent;
            });
        }

        // 点击模态框外部关闭功能已禁用，防止误操作导致数据丢失
        // 用户只能通过以下方式关闭模态框：
        // 1. 点击右上角的 "×" 关闭按钮
        // 2. 点击"取消"按钮
        // 3. 按 ESC 键关闭
        // 4. 表单提交成功后自动关闭

        // 通用复制到剪贴板函数
        function copyToClipboard(text) {
            return new Promise((resolve, reject) => {
                // 现代浏览器API
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(resolve).catch(reject);
                } else {
                    // 降级方案：使用传统的execCommand方法
                    try {
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();

                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);

                        if (successful) {
                            resolve();
                        } else {
                            reject(new Error('execCommand复制失败'));
                        }
                    } catch (err) {
                        reject(err);
                    }
                }
            });
        }

        // Token 操作函数
        function copyToken(token) {
            copyToClipboard(token).then(function() {
                showNotification('Token 已复制到剪贴板', 'success');
            }).catch(function(error) {
                console.error('复制Token失败:', error);
                showNotification('复制Token失败: ' + error.message, 'error');
            });
        }

        // 编辑器集成功能
        function useInEditor(editorType) {
            if (!window.currentUseTokenId) {
                showNotification('未选择 Token', 'error');
                return;
            }

            // 获取当前 Token 的详细信息
            fetch(`/api/tokens/${window.currentUseTokenId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const token = data.data;

                        // 检查必要字段
                        if (!token.access_token) {
                            showNotification('Token 缺少 access_token 字段', 'error');
                            return;
                        }

                        if (!token.tenant_url) {
                            showNotification('Token 缺少 tenant_url 字段', 'error');
                            return;
                        }

                        if (!token.portal_url) {
                            showNotification('Token 缺少 portal_url 字段', 'error');
                            return;
                        }

                        // 构建编辑器协议 URL
                        const editorUrl = buildEditorURL(editorType, token);

                        // 打开编辑器
                        try {
                            window.open(editorUrl, '_blank');
                            showNotification(`正在打开 ${getEditorDisplayName(editorType)}...`, 'success');
                            closeUseModal();
                        } catch (error) {
                            showNotification(`打开 ${getEditorDisplayName(editorType)} 失败: ` + error.message, 'error');
                        }
                    } else {
                        showNotification('获取 Token 信息失败: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    showNotification('获取 Token 信息失败: ' + error.message, 'error');
                });
        }

        // 构建编辑器协议 URL
        function buildEditorURL(editorType, token) {
            const accessToken = encodeURIComponent(token.access_token);
            const tenantUrl = encodeURIComponent(token.tenant_url);
            const portalUrl = encodeURIComponent(token.portal_url || '');

            // 根据编辑器类型构建不同的协议 URL
            const protocolMap = {
                'vscode': 'vscode',
                'cursor': 'cursor',
                'kiro': 'kiro',
                'trae': 'trae'
            };

            const protocol = protocolMap[editorType] || 'vscode';
            const editorUrl = `${protocol}://augment.vscode-augment/autoAuth?token=${accessToken}&url=${tenantUrl}&portal=${portalUrl}`;

            console.log(`[DEBUG] 构建的 ${editorType} URL:`, editorUrl);
            return editorUrl;
        }

        // 获取编辑器显示名称
        function getEditorDisplayName(editorType) {
            const displayNames = {
                'vscode': 'VSCode',
                'cursor': 'Cursor',
                'kiro': 'Kiro',
                'trae': 'Trae'
            };
            return displayNames[editorType] || editorType;
        }

        // 保留原有的 useInVSCode 函数作为兼容
        function useInVSCode() {
            useInEditor('vscode');
        }

        // 保留原有的 useToken 函数作为备用
        function useToken(token, tokenId) {
            // 复制 token 到剪贴板
            copyToken(token);
            showNotification('Token 已复制到剪贴板', 'success');
        }

        // URL格式验证函数
        function isValidURL(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }

        function editToken(tokenId) {
            // 获取 Token 详细信息并填充编辑表单
            fetch(`/api/tokens/${tokenId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const token = data.data;
                        document.getElementById('edit_token_id').value = token.id;
                        document.getElementById('edit_tenant_url').value = token.tenant_url || '';
                        document.getElementById('edit_access_token').value = token.access_token || '';
                        document.getElementById('edit_portal_url').value = token.portal_url || '';
                        document.getElementById('edit_email_note').value = token.email_note || '';
                        openEditModal();
                    } else {
                        showNotification('获取 Token 信息失败: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    showNotification('获取 Token 信息失败: ' + error.message, 'error');
                });
        }

        // 全局变量存储要删除的Token ID
        let tokenToDelete = null;

        function deleteToken(id) {
            // 存储要删除的Token ID
            tokenToDelete = id;

            // 获取Token信息以显示在确认对话框中
            fetch(`/api/tokens/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const token = data.data;
                        let tokenInfo = '';

                        if (token.email_note && token.email_note.trim() !== '') {
                            tokenInfo = `邮箱备注: ${token.email_note}`;
                        } else {
                            // 显示Token ID的前8位和后4位
                            const maskedId = token.id.length > 12
                                ? `${token.id.substring(0, 8)}...${token.id.substring(token.id.length - 4)}`
                                : token.id;
                            tokenInfo = `Token ID: ${maskedId}`;
                        }

                        if (token.tenant_url) {
                            tokenInfo += `<br>Tenant URL: ${token.tenant_url}`;
                        }

                        document.getElementById('deleteTokenInfo').innerHTML = tokenInfo;
                        openDeleteConfirmModal();
                    } else {
                        showNotification('获取 Token 信息失败: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('获取 Token 信息错误:', error);
                    // 即使获取信息失败，也显示确认对话框
                    document.getElementById('deleteTokenInfo').innerHTML = `Token ID: ${id}`;
                    openDeleteConfirmModal();
                });
        }

        function openDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            tokenToDelete = null;
        }

        function confirmDeleteToken() {
            if (!tokenToDelete) {
                showNotification('没有选择要删除的 Token', 'error');
                return;
            }

            // 显示加载状态
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const originalContent = confirmBtn.innerHTML;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="btn-icon bi bi-arrow-clockwise spinning"></span><span>删除中...</span>';

            // 发送删除请求
            fetch(`/api/tokens/${tokenToDelete}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message || 'Token 删除成功', 'success');
                    closeDeleteConfirmModal();
                    // 动态刷新Token列表，智能处理页面跳转
                    setTimeout(() => {
                        // 计算当前页的记录数
                        const currentPageRecords = Math.min(pageSize, totalRecords - (currentPage - 1) * pageSize);

                        // 如果当前页只有一条记录且不是第一页，删除后回到上一页
                        if (currentPageRecords === 1 && currentPage > 1) {
                            goToPage(currentPage - 1);
                        } else {
                            refreshTokenList();
                        }
                    }, 500);
                } else {
                    showNotification(data.error || '删除 Token 失败', 'error');
                }
            })
            .catch(error => {
                console.error('删除 Token 错误:', error);
                showNotification('删除 Token 失败: ' + error.message, 'error');
            })
            .finally(() => {
                // 恢复按钮状态
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalContent;
            });
        }

        // 刷新单个 Token
        function refreshToken(tokenId) {
            // 精确选择刷新按钮，避免选择到其他具有相同data-token-id的元素
            const refreshBtn = document.querySelector(`button[data-token-id="${tokenId}"][onclick*="refreshToken"]`);
            if (!refreshBtn) {
                console.error(`找不到Token ${tokenId}的刷新按钮`);
                return;
            }

            const originalContent = refreshBtn.innerHTML;

            // 显示加载状态
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<span class="btn-icon bi bi-arrow-clockwise spinning"></span>';

            // 调用刷新 API 获取最新信息
            fetch(`/api/tokens/${tokenId}/refresh`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 更新页面上的显示
                        updateTokenRow(tokenId, data.data);
                        showNotification(data.message || 'Token 信息已刷新', 'success');
                    } else {
                        showNotification('刷新失败: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    showNotification('刷新失败: ' + error.message, 'error');
                })
                .finally(() => {
                    // 恢复按钮状态
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = originalContent;
                });
        }

        // 批量刷新所有 Token
        function batchRefreshTokens() {
            const batchBtn = document.getElementById('batchRefreshBtn');
            const originalContent = batchBtn.innerHTML;

            // 获取所有 Token ID
            const tokenRows = document.querySelectorAll('[data-token-id]');
            const tokenIds = Array.from(tokenRows).map(row => row.getAttribute('data-token-id'));

            if (tokenIds.length === 0) {
                showNotification('没有 Token 需要刷新', 'info');
                return;
            }

            // 显示加载状态
            batchBtn.disabled = true;
            batchBtn.innerHTML = `<span class="btn-icon bi bi-arrow-clockwise spinning"></span><span>正在刷新...</span>`;

            // 调用批量刷新 API
            fetch('/api/tokens/batch-refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 更新所有成功刷新的 Token 显示
                        if (data.data && data.data.tokens) {
                            data.data.tokens.forEach(tokenData => {
                                updateTokenRow(tokenData.id, tokenData);
                            });
                        }

                        // 显示结果通知
                        const { total, success, failed } = data.data;
                        if (failed === 0) {
                            showNotification(data.message || `成功刷新 ${success} 个 Token`, 'success');
                        } else if (success > 0) {
                            showNotification(data.message || `刷新完成：${success} 个成功，${failed} 个失败`, 'warning');
                        } else {
                            showNotification(data.message || `刷新失败：所有 ${failed} 个 Token 都刷新失败`, 'error');
                        }

                        // 如果有错误详情，在控制台显示
                        if (data.errors && data.errors.length > 0) {
                            console.warn('批量刷新错误详情:', data.errors);
                        }
                    } else {
                        showNotification('批量刷新失败: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    showNotification('批量刷新失败: ' + error.message, 'error');
                })
                .finally(() => {
                    // 恢复按钮状态
                    batchBtn.disabled = false;
                    batchBtn.innerHTML = originalContent;
                });
        }

        // 更新 Token 行显示
        function updateTokenRow(tokenId, tokenData) {
            // 使用刷新按钮来定位表格行，确保选择正确的元素
            const refreshBtn = document.querySelector(`button[data-token-id="${tokenId}"][onclick*="refreshToken"]`);
            if (!refreshBtn) {
                console.error(`找不到Token ${tokenId}的刷新按钮`);
                return;
            }
            const tokenRow = refreshBtn.closest('tr');
            if (!tokenRow) return;

            const cells = tokenRow.querySelectorAll('td');

            // 更新邮箱备注
            const emailCell = cells[0];
            if (emailCell) {
                emailCell.querySelector('.email-note').textContent = tokenData.email_note || '-';
            }

            // 更新过期时间
            const expiryCell = cells[2];
            if (expiryCell) {
                const expiryResult = parseExpiryFromPortalInfo(tokenData.portal_info);
                const dateTimeElement = expiryCell.querySelector('.date-time');
                dateTimeElement.textContent = expiryResult.text;
                // 移除旧的过期时间样式类
                dateTimeElement.classList.remove('expiry-safe', 'expiry-warning', 'expiry-critical', 'expiry-expired', 'expiry-unknown');
                // 添加新的样式类
                dateTimeElement.classList.add(expiryResult.class);
            }

            // 更新剩余次数
            const creditsCell = cells[3];
            if (creditsCell) {
                const credits = parseCreditsFromPortalInfo(tokenData.portal_info);
                creditsCell.querySelector('.credits-balance').textContent = credits;
            }
        }

        // 计算剩余时间并格式化显示
        function formatTimeRemaining(expiryDate) {
            if (!expiryDate || isNaN(expiryDate.getTime())) {
                return { text: '未知', class: 'expiry-unknown' };
            }

            const now = new Date();
            const timeDiff = expiryDate.getTime() - now.getTime();

            // 已过期
            if (timeDiff <= 0) {
                return { text: '已过期', class: 'expiry-expired' };
            }

            // 计算剩余时间
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const minutes = Math.floor(timeDiff / (1000 * 60));

            let text, cssClass;

            if (days >= 1) {
                text = `${days}天`;
                cssClass = days > 7 ? 'expiry-safe' : 'expiry-warning';
            } else if (hours >= 1) {
                text = `${hours}小时`;
                cssClass = 'expiry-critical';
            } else if (minutes >= 1) {
                text = `${minutes}分钟`;
                cssClass = 'expiry-critical';
            } else {
                text = '即将过期';
                cssClass = 'expiry-expired';
            }

            return { text, class: cssClass };
        }

        // 从 portal_info 解析过期时间
        function parseExpiryFromPortalInfo(portalInfo) {

            if (!portalInfo || portalInfo === '{}') {
                return { text: '未知', class: 'expiry-unknown' };
            }

            let expiryDate = null;

            try {
                const info = JSON.parse(portalInfo);
                if (info.expiry_date) {
                    expiryDate = new Date(info.expiry_date);
                }
            } catch (e) {
                // 降级到字符串匹配
                const match = portalInfo.match(/"expiry_date":\s*"([^"]+)"/);
                if (match) {
                    expiryDate = new Date(match[1]);
                }
            }

            const result = formatTimeRemaining(expiryDate);
            return result;
        }

        // 从 portal_info 解析剩余次数
        function parseCreditsFromPortalInfo(portalInfo) {
            if (!portalInfo || portalInfo === '{}') return '0';

            try {
                const info = JSON.parse(portalInfo);
                return info.credits_balance ? info.credits_balance.toString() : '0';
            } catch (e) {
                // 降级到字符串匹配
                const match = portalInfo.match(/"credits_balance":\s*(\d+)/);
                return match ? match[1] : '0';
            }
        }

        // 通知函数
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;

            // 添加到页面
            document.body.appendChild(notification);

            // 显示动画
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // 自动隐藏
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 添加Token表单提交处理
        document.getElementById('addTokenForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // 获取表单数据
            const formData = new FormData(this);
            const tokenData = {
                tenant_url: formData.get('tenant_url').trim(),
                access_token: formData.get('access_token').trim(),
                portal_url: formData.get('portal_url').trim(),
                email_note: formData.get('email_note').trim()
            };

            // 验证必填字段
            if (!tokenData.tenant_url) {
                showNotification('Tenant URL 不能为空', 'error');
                return;
            }

            if (!tokenData.access_token) {
                showNotification('Access Token 不能为空', 'error');
                return;
            }

            // 验证URL格式
            if (!isValidURL(tokenData.tenant_url)) {
                showNotification('Tenant URL 格式不正确', 'error');
                return;
            }

            if (tokenData.portal_url && !isValidURL(tokenData.portal_url)) {
                showNotification('Portal URL 格式不正确', 'error');
                return;
            }

            // 显示加载状态
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalContent = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="btn-icon bi bi-arrow-clockwise spinning"></span><span>创建中...</span>';

            // 发送创建请求
            fetch('/api/tokens', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(tokenData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message || 'Token 创建成功', 'success');
                    closeAddModal();
                    // 动态刷新Token列表，回到第一页显示新添加的Token
                    setTimeout(() => {
                        refreshTokenListToFirstPage();
                    }, 500);
                } else {
                    showNotification(data.error || '创建 Token 失败', 'error');
                }
            })
            .catch(error => {
                console.error('创建 Token 错误:', error);
                showNotification('创建 Token 失败: ' + error.message, 'error');
            })
            .finally(() => {
                // 恢复按钮状态
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalContent;
            });
        });

        // 编辑Token表单提交处理
        document.getElementById('editTokenForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // 获取表单数据
            const formData = new FormData(this);
            const tokenId = formData.get('token_id');
            const tokenData = {
                tenant_url: formData.get('tenant_url').trim(),
                access_token: formData.get('access_token').trim(),
                portal_url: formData.get('portal_url').trim(),
                email_note: formData.get('email_note').trim()
            };

            // 验证必填字段
            if (!tokenData.tenant_url) {
                showNotification('Tenant URL 不能为空', 'error');
                return;
            }

            if (!tokenData.access_token) {
                showNotification('Access Token 不能为空', 'error');
                return;
            }

            // 验证URL格式
            if (!isValidURL(tokenData.tenant_url)) {
                showNotification('Tenant URL 格式不正确', 'error');
                return;
            }

            if (tokenData.portal_url && !isValidURL(tokenData.portal_url)) {
                showNotification('Portal URL 格式不正确', 'error');
                return;
            }

            // 显示加载状态
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalContent = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="btn-icon bi bi-arrow-clockwise spinning"></span><span>更新中...</span>';

            // 发送更新请求
            fetch(`/api/tokens/${tokenId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(tokenData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message || 'Token 更新成功', 'success');
                    closeEditModal();
                    // 动态刷新Token列表，保持当前页面
                    setTimeout(() => {
                        refreshTokenList();
                    }, 500);
                } else {
                    showNotification(data.error || '更新 Token 失败', 'error');
                }
            })
            .catch(error => {
                console.error('更新 Token 错误:', error);
                showNotification('更新 Token 失败: ' + error.message, 'error');
            })
            .finally(() => {
                // 恢复按钮状态
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalContent;
            });
        });

        // ESC 键关闭模态框功能已禁用，防止误操作导致数据丢失
        // 如果需要重新启用，可以取消注释以下代码：
        /*
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // 只允许关闭非表单类的模态框，避免数据丢失
                closeUseModal();
                closeDeleteConfirmModal();
                // 表单类模态框需要用户明确操作：
                // closeAddModal();
                // closeEditModal();
                // closeGetTokenModal();
            }
        });
        */

        // 登出功能
        function logout() {
            if (!confirm('确定要登出吗？')) {
                return;
            }

            fetch('/api/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message || '登出成功', 'success');
                    // 延迟跳转到登录页
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1000);
                } else {
                    showNotification(data.error || '登出失败', 'error');
                }
            })
            .catch(error => {
                console.error('登出错误:', error);
                // 即使出错也跳转到登录页
                window.location.href = '/login';
            });
        }

        // 解析并显示过期时间
        function parseAndDisplayExpiryTimes() {
            const expiryDisplays = document.querySelectorAll('.expiry-display');

            expiryDisplays.forEach(display => {
                const tokenId = display.getAttribute('data-token-id');
                const portalInfo = display.getAttribute('data-portal-info');

                const expiryResult = parseExpiryFromPortalInfo(portalInfo);
                display.textContent = expiryResult.text;

                // 移除旧的过期时间样式类
                display.classList.remove('expiry-safe', 'expiry-warning', 'expiry-critical', 'expiry-expired', 'expiry-unknown');
                // 添加新的样式类
                display.classList.add(expiryResult.class);
            });
        }

        // 解析并显示Token状态
        function parseAndDisplayTokenStatus() {
            const statusBadges = document.querySelectorAll('.status-badge');

            statusBadges.forEach(badge => {
                const tokenId = badge.getAttribute('data-token-id');
                const portalInfo = badge.getAttribute('data-portal-info');

                let isActive = true; // 默认为激活状态

                if (portalInfo && portalInfo !== '{}') {
                    try {
                        const info = JSON.parse(portalInfo);
                        isActive = info.is_active !== false; // 只有明确为false时才是失效
                    } catch (e) {
                        // JSON解析失败，使用字符串匹配
                        if (portalInfo.includes('"is_active": false') || portalInfo.includes('"is_active":false')) {
                            isActive = false;
                        }
                    }
                }

                // 创建状态标签
                const badgeElement = document.createElement('span');
                badgeElement.className = `badge ${isActive ? 'status-active' : 'status-inactive'}`;
                badgeElement.textContent = isActive ? '正常' : '失效';

                // 清空并添加标签
                badge.innerHTML = '';
                badge.appendChild(badgeElement);

                // 为失效的Token添加行样式
                const row = badge.closest('tr');
                if (row) {
                    if (isActive) {
                        row.classList.remove('token-inactive');
                    } else {
                        row.classList.add('token-inactive');
                    }
                }
            });
        }

        // 页面加载时检查认证状态和解析Token状态
        window.addEventListener('load', function() {
            // 检查是否已认证
            fetch('/api/tokens', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => {
                if (response.status === 401) {
                    // 未认证，跳转到登录页
                    window.location.href = '/login';
                } else {
                    // 已认证，加载分页数据
                    loadTokensWithPagination(1, 10);
                }
            })
            .catch(error => {
                console.error('认证检查错误:', error);
            });
        });

        // 分页相关变量
        let currentPage = 1;
        const pageSize = 10; // 固定每页显示10条
        let totalPages = 1;
        let totalRecords = 0;

        // 分页功能
        function loadTokensWithPagination(page = 1, limit = 10, showLoading = true) {
            const url = `/api/tokens?page=${page}&limit=${limit}`;
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const tableContainer = document.querySelector('.token-table-container');

            // 只在需要时显示加载状态（避免频繁闪烁）
            if (showLoading) {
                loadingState.style.display = 'block';
                emptyState.style.display = 'none';
                tableContainer.style.display = 'none';
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateTokenTable(data.data);
                        if (data.pagination) {
                            updatePagination(data.pagination);
                        } else {
                            // 如果没有分页信息，隐藏分页器
                            document.getElementById('paginationContainer').style.display = 'none';
                        }
                    } else {
                        console.error('获取分页数据失败:', data.error);
                        showNotification('获取数据失败: ' + data.error, 'error');
                        // 显示空状态
                        loadingState.style.display = 'none';
                        emptyState.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('请求失败:', error);
                    showNotification('网络请求失败: ' + error.message, 'error');
                    // 显示空状态
                    loadingState.style.display = 'none';
                    emptyState.style.display = 'block';
                });
        }

        function updateTokenTable(tokens) {
            const tbody = document.querySelector('#tokenTableBody');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const tableContainer = document.querySelector('.token-table-container');

            if (!tbody) return;

            // 隐藏加载状态
            loadingState.style.display = 'none';

            if (tokens && tokens.length > 0) {
                // 显示表格，隐藏空状态
                tableContainer.style.display = 'block';
                emptyState.style.display = 'none';

                // 清空并填充表格
                tbody.innerHTML = '';
                tokens.forEach(token => {
                    const row = createTokenRow(token);
                    tbody.appendChild(row);
                });

                // 注意：过期时间和状态现在在 createTokenRow 中直接设置，不需要额外解析
            } else {
                // 显示空状态，隐藏表格
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
            }
        }

        function createTokenRow(token) {
            const row = document.createElement('tr');

            // 解析过期时间和状态
            const expiryResult = parseExpiryFromPortalInfo(token.portal_info || '{}');
            const creditsBalance = parseCreditsFromPortalInfo(token.portal_info || '{}');

            row.innerHTML = `
                <td>
                    <div class="email-note">${token.email_note || '-'}</div>
                </td>
                <td>
                    <div class="date-time">${new Date(token.created_at).toLocaleString('zh-CN')}</div>
                </td>
                <td>
                    <div class="date-time expiry-display ${expiryResult.class}" data-token-id="${token.id}">
                        ${expiryResult.text}
                    </div>
                </td>
                <td>
                    <div class="credits-balance">${creditsBalance}</div>
                </td>
                <td>
                    <div class="status-badge" data-token-id="${token.id}">
                        <!-- 状态将通过JavaScript动态设置 -->
                    </div>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-primary" onclick="openUseModal('${token.id}')" title="使用 Token">
                            <span class="btn-icon bi bi-link-45deg"></span>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="refreshToken('${token.id}')" title="刷新 Token 信息" data-token-id="${token.id}">
                            <span class="btn-icon bi bi-arrow-clockwise"></span>
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="editToken('${token.id}')" title="编辑 Token">
                            <span class="btn-icon bi bi-pencil"></span>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteToken('${token.id}')" title="删除 Token">
                            <span class="btn-icon bi bi-trash"></span>
                        </button>
                    </div>
                </td>
            `;

            // 设置状态标签（需要在DOM插入后设置，因为需要访问元素）
            setTimeout(() => {
                const statusBadge = row.querySelector('.status-badge');
                if (statusBadge) {
                    // 解析状态信息
                    let isActive = true;
                    const portalInfo = token.portal_info || '{}';

                    if (portalInfo && portalInfo !== '{}') {
                        try {
                            const info = JSON.parse(portalInfo);
                            isActive = info.is_active !== false;
                        } catch (e) {
                            // JSON解析失败，使用字符串匹配
                            if (portalInfo.includes('"is_active": false') || portalInfo.includes('"is_active":false')) {
                                isActive = false;
                            }
                        }
                    }

                    // 创建状态标签
                    const badgeElement = document.createElement('span');
                    badgeElement.className = `badge ${isActive ? 'status-active' : 'status-inactive'}`;
                    badgeElement.textContent = isActive ? '正常' : '失效';

                    statusBadge.appendChild(badgeElement);

                    // 为失效的Token添加行样式
                    if (!isActive) {
                        row.classList.add('token-inactive');
                    }
                }
            }, 0);

            return row;
        }

        function updatePagination(pagination) {
            currentPage = pagination.page;
            // pageSize 现在是常量，固定为10，不需要从服务器更新
            totalPages = pagination.total_pages;
            totalRecords = pagination.total;

            // 智能显示/隐藏分页器
            const paginationContainer = document.getElementById('paginationContainer');

            // 当数据量不满足分页条件时隐藏分页器
            // 条件：总记录数 <= 每页显示数量（即单页可以显示所有数据）
            if (totalRecords <= pageSize) {
                paginationContainer.style.display = 'none';
                return;
            } else {
                paginationContainer.style.display = 'block';
            }

            // 更新分页信息
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, totalRecords);
            document.getElementById('paginationInfo').textContent =
                `显示第 ${start}-${end} 条，共 ${totalRecords} 条记录`;

            // 更新导航按钮状态
            document.getElementById('firstPageBtn').disabled = currentPage === 1;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            document.getElementById('lastPageBtn').disabled = currentPage === totalPages;

            // 生成页码按钮
            generatePageButtons();
        }

        function generatePageButtons() {
            const pagesContainer = document.getElementById('paginationPages');
            pagesContainer.innerHTML = '';

            // 计算显示的页码范围
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            // 确保显示至少5个页码（如果总页数足够）
            if (endPage - startPage < 4) {
                if (startPage === 1) {
                    endPage = Math.min(totalPages, startPage + 4);
                } else if (endPage === totalPages) {
                    startPage = Math.max(1, endPage - 4);
                }
            }

            // 添加第一页和省略号
            if (startPage > 1) {
                addPageButton(1);
                if (startPage > 2) {
                    addEllipsis();
                }
            }

            // 添加页码按钮
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(i);
            }

            // 添加省略号和最后一页
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    addEllipsis();
                }
                addPageButton(totalPages);
            }
        }

        function addPageButton(pageNum) {
            const button = document.createElement('button');
            button.className = `pagination-page-btn ${pageNum === currentPage ? 'active' : ''}`;
            button.textContent = pageNum;
            button.onclick = () => goToPage(pageNum);
            document.getElementById('paginationPages').appendChild(button);
        }

        function addEllipsis() {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'pagination-ellipsis';
            ellipsis.textContent = '...';
            document.getElementById('paginationPages').appendChild(ellipsis);
        }

        // 分页导航函数
        function goToPage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                loadTokensWithPagination(page, pageSize);
            }
        }

        function goToPrevPage() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        }

        function goToNextPage() {
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        }

        function goToLastPage() {
            goToPage(totalPages);
        }

        // 动态刷新Token列表（不刷新整个页面）
        function refreshTokenList() {
            loadTokensWithPagination(currentPage, pageSize, false); // 不显示加载状态，避免闪烁
        }

        // 重置到第一页并刷新Token列表
        function refreshTokenListToFirstPage() {
            loadTokensWithPagination(1, pageSize, false); // 不显示加载状态，避免闪烁
        }

        // ==================== 批量导入功能 ====================

        let csvData = [];
        let validData = [];

        // 标签页切换
        function switchAddTab(tabName) {
            // 移除所有活动状态
            document.querySelectorAll('.tab-nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // 激活选中的标签页
            document.getElementById(tabName + 'AddTab').classList.add('active');
            document.getElementById(tabName + 'AddContent').classList.add('active');

            // 重置批量导入状态
            if (tabName === 'batch') {
                resetBatchImportState();
            }
        }

        // 重置批量导入状态
        function resetBatchImportState() {
            csvData = [];
            validData = [];
            document.getElementById('fileUploadArea').innerHTML = `
                <div class="upload-placeholder">
                    <i class="bi bi-cloud-upload" style="font-size: 48px; color: #007bff;"></i>
                    <p>拖拽 CSV 文件到此处，或 <a href="#" onclick="triggerFileSelect()">点击选择文件</a></p>
                    <p class="upload-hint">支持的格式：CSV 文件，最大 5MB</p>
                </div>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
            `;
            document.getElementById('importProgressSection').style.display = 'none';
            document.getElementById('batchImportBtn').disabled = true;
        }

        // 触发文件选择
        function triggerFileSelect() {
            document.getElementById('csvFileInput').click();
        }

        // 下载CSV模板
        function downloadCSVTemplate() {
            const csvContent = `tenant_url,access_token,portal_url,email_note
https://d18.api.augmentcode.com/,your_access_token_here,https://portal.withorb.com/view?token=xxx,用户备注1
https://d16.api.augmentcode.com/,your_access_token_here,https://portal.withorb.com/view?token=yyy,用户备注2`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'token_import_template.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 处理文件选择
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processCSVFile(file);
            }
        }

        // 处理拖拽上传
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('fileUploadArea');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                        processCSVFile(file);
                    } else {
                        showNotification('请选择 CSV 格式的文件', 'error');
                    }
                }
            });
        }

        // 处理CSV文件
        function processCSVFile(file) {
            if (file.size > 5 * 1024 * 1024) { // 5MB限制
                showNotification('文件大小不能超过 5MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                parseCSVData(csvText, file.name);
            };
            reader.readAsText(file, 'UTF-8');
        }

        // 解析CSV数据
        function parseCSVData(csvText, fileName) {
            try {
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) {
                    showNotification('CSV 文件至少需要包含表头和一行数据', 'error');
                    return;
                }

                // 解析表头
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

                // 验证必需的列
                const requiredColumns = ['tenant_url', 'access_token'];
                const missingColumns = requiredColumns.filter(col => !headers.includes(col));
                if (missingColumns.length > 0) {
                    showNotification(`CSV 文件缺少必需的列: ${missingColumns.join(', ')}`, 'error');
                    return;
                }

                // 解析数据行
                csvData = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length === headers.length) {
                        const rowData = {};
                        headers.forEach((header, index) => {
                            rowData[header] = values[index] || '';
                        });
                        csvData.push(rowData);
                    }
                }

                if (csvData.length === 0) {
                    showNotification('CSV 文件中没有有效的数据行', 'error');
                    return;
                }

                // 验证数据
                validateCSVData();

                // 直接启用导入按钮，跳过预览步骤
                enableImportButton(fileName);

            } catch (error) {
                console.error('CSV 解析错误:', error);
                showNotification('CSV 文件格式错误，请检查文件格式', 'error');
            }
        }

        // 解析CSV行（处理引号和逗号）
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current.trim());
            return result;
        }

        // 验证CSV数据
        function validateCSVData() {
            validData = [];
            const errors = [];

            csvData.forEach((row, index) => {
                const rowErrors = [];

                // 验证必填字段
                if (!row.tenant_url || !row.tenant_url.trim()) {
                    rowErrors.push('Tenant URL 不能为空');
                }
                if (!row.access_token || !row.access_token.trim()) {
                    rowErrors.push('Access Token 不能为空');
                }

                // 验证URL格式
                if (row.tenant_url && !isValidURL(row.tenant_url)) {
                    rowErrors.push('Tenant URL 格式无效');
                }
                if (row.portal_url && row.portal_url.trim() && !isValidURL(row.portal_url)) {
                    rowErrors.push('Portal URL 格式无效');
                }

                if (rowErrors.length === 0) {
                    validData.push(row);
                } else {
                    errors.push(`第 ${index + 2} 行: ${rowErrors.join(', ')}`);
                }
            });

            if (errors.length > 0) {
                console.warn('数据验证错误:', errors);
            }
        }

        // 验证URL格式
        function isValidURL(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // 启用导入按钮并显示文件信息
        function enableImportButton(fileName) {
            // 更新文件上传区域显示已选择的文件
            document.getElementById('fileUploadArea').innerHTML = `
                <div class="upload-success">
                    <i class="bi bi-check-circle" style="font-size: 48px; color: #28a745;"></i>
                    <p><strong>文件已选择：</strong>${fileName}</p>
                    <p class="upload-stats">
                        总行数：${csvData.length} |
                        有效数据：${validData.length} |
                        ${csvData.length - validData.length > 0 ? `错误数据：${csvData.length - validData.length}` : ''}
                    </p>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="resetBatchImportState()" title="重新选择文件">
                        <span class="btn-icon bi bi-arrow-clockwise"></span>
                        <span>重新选择文件</span>
                    </button>
                </div>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
            `;

            // 启用或禁用导入按钮
            const importBtn = document.getElementById('batchImportBtn');
            if (validData.length === 0) {
                importBtn.disabled = true;
                showNotificationWithDuration(`CSV文件解析失败：文件中没有有效的数据行，请检查文件格式`, 'error', 5000);
            } else {
                importBtn.disabled = false;
                if (csvData.length - validData.length > 0) {
                    showNotificationWithDuration(`CSV文件解析完成：发现 ${csvData.length - validData.length} 行数据有错误，将跳过这些行进行导入`, 'warning', 5000);
                } else {
                    showNotificationWithDuration(`CSV文件解析成功：共 ${validData.length} 行有效数据，可以开始导入`, 'success', 4000);
                }
            }
        }

        // 开始批量导入
        function startBatchImport() {
            if (validData.length === 0) {
                showNotification('没有有效的数据可以导入', 'error');
                return;
            }

            // 显示进度条
            document.getElementById('importProgressSection').style.display = 'block';
            document.getElementById('batchImportBtn').disabled = true;

            // 批量导入数据
            importTokensBatch(validData);
        }

        // 批量导入Token
        async function importTokensBatch(tokens) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const total = tokens.length;

            progressText.textContent = `正在导入 ${total} 条记录...`;
            progressFill.style.width = '50%';

            try {
                const response = await fetch('/api/tokens/batch-import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tokens: tokens
                    })
                });

                const data = await response.json();

                progressFill.style.width = '100%';
                progressText.textContent = '导入完成';

                if (data.success) {
                    // 显示导入结果
                    showImportResult(data.successful, data.failed, data.errors || []);
                } else {
                    showImportResult(0, total, [data.error || '批量导入失败']);
                }
            } catch (error) {
                progressFill.style.width = '100%';
                progressText.textContent = '导入失败';
                showImportResult(0, total, [`网络错误: ${error.message}`]);
            }
        }

        // 处理导入结果
        function showImportResult(successful, failed, errors) {
            // 显示详细的通知信息
            showImportNotification(successful, failed, errors.length);

            // 如果有成功导入的数据，刷新Token列表
            if (successful > 0) {
                setTimeout(() => {
                    refreshTokenListToFirstPage();
                }, 1000);
            }

            // 重置导入按钮状态，允许用户进行下一次导入
            document.getElementById('batchImportBtn').disabled = false;
            document.getElementById('batchImportBtn').innerHTML = `
                <span class="btn-icon bi bi-upload"></span>
                <span>开始导入</span>
            `;
        }

        // 显示批量导入通知
        function showImportNotification(successful, failed, errorCount) {
            const total = successful + failed;
            let message = '';
            let type = '';
            let duration = 3000; // 默认3秒

            if (failed === 0 && successful > 0) {
                // 完全成功
                message = `批量导入成功：成功导入 ${successful} 条 Token 记录`;
                type = 'success';
                duration = 4000; // 4秒
            } else if (failed > 0 && successful > 0) {
                // 部分成功
                message = `批量导入部分成功：成功 ${successful} 条，失败 ${failed} 条，请查看详细错误信息`;
                type = 'warning';
                duration = 6000; // 6秒，让用户有时间阅读
            } else if (successful === 0 && failed > 0) {
                // 完全失败
                message = `批量导入失败：所有 ${total} 条记录导入失败，请检查数据格式`;
                type = 'error';
                duration = 6000; // 6秒
            } else {
                // 异常情况
                message = '批量导入操作完成，但结果异常';
                type = 'error';
                duration = 4000;
            }

            // 显示通知
            showNotificationWithDuration(message, type, duration);
        }

        // 带自定义持续时间的通知函数
        function showNotificationWithDuration(message, type = 'info', duration = 3000) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;

            // 添加到页面
            document.body.appendChild(notification);

            // 显示动画
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // 自动隐藏
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }



        // 页面加载时设置拖拽上传
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟设置拖拽上传，确保DOM已加载
            setTimeout(setupDragAndDrop, 100);
        });
    </script>
</body>
</html>
